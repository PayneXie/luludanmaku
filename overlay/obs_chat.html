<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Bilibili Overlay</title>
    <!-- 解决B站图片403 Forbidden问题 -->
    <meta name="referrer" content="no-referrer">
    <!-- Socket.io CDN -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        /* 基础重置 */
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: transparent;
        }

        /* 模拟 YouTube 直播聊天的容器结构，以便兼容 CSS */
        yt-live-chat-renderer {
            display: block;
            height: 100%;
            width: 100%;
            background-color: transparent;
        }

        yt-live-chat-item-list-renderer {
            display: block;
            height: 100%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: flex-end; /* 消息底部对齐 */
        }

        #items {
            display: flex;
            flex-direction: column;
            padding: 8px;
            overflow: hidden;
        }

        /* -----------------------------------------------------
           组件样式定义 (模拟 YouTube 结构)
           ----------------------------------------------------- */
        
        /* 1. 普通弹幕 (模拟 yt-live-chat-text-message-renderer) */
        yt-live-chat-text-message-renderer {
            /* 关键修复：恢复 flex 布局，这是 YouTube 默认布局的基础 */
            display: flex;
            align-items: flex-start;
            margin-bottom: 8px; /* 增加消息间距 */
            padding: 4px 24px;  /* 增加左右内边距 */
            position: relative;
            font-size: 16px;
        }

        #author-photo {
            display: block; /* 恢复为 block，因为是 flex item */
            margin-right: 16px; /* 增加头像和内容的间距 */
            overflow: hidden;
            border-radius: 50%;
            flex-shrink: 0; /* 防止头像被压缩 */
        }
        
        #author-photo img {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%; /* 确保图片本身也是圆的 */
        }

        #content {
            display: flex; /* 关键：内容区域改为 flex column，让名字和消息换行 */
            flex-direction: column;
            min-width: 0; /* 防止 flex item 溢出 */
            align-items: flex-start; /* 左对齐 */
        }

        /* 时间戳 (默认隐藏，CSS 控制) */
        #timestamp {
            display: none;
            /* ...保留原有属性 */
        }

        yt-live-chat-author-chip {
            display: inline-flex;
            align-items: baseline;
            margin-bottom: 2px; /* 名字和消息之间的微小间距 */
            vertical-align: baseline;
        }

        #author-name {
            font-weight: 500;
            color: var(--yt-live-chat-secondary-text-color, #111);
            /* 去掉可能导致颜色不对的透明背景设置，如果之前有的话 */
        }

        #message {
            color: var(--yt-live-chat-primary-text-color, #000);
            word-wrap: break-word;
            word-break: break-word;
            line-height: 1.4; /* 稍微增加行高 */
            display: inline-block; /* 确保它是个块，或者根据 flex 布局自动调整 */
        }

        /* 2. SuperChat (模拟 yt-live-chat-paid-message-renderer) */
        yt-live-chat-paid-message-renderer {
            display: flex;
            flex-direction: column;
            border-radius: 4px;
            margin: 4px 24px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 2px 2px 0 rgba(0,0,0,0.14), 0 1px 5px 0 rgba(0,0,0,0.12), 0 3px 1px -2px rgba(0,0,0,0.2);
        }

        #card {
            display: flex;
            flex-direction: column;
        }

        #header {
            display: flex;
            align-items: center;
            padding: 8px 16px;
            color: rgba(0,0,0,0.87);
        }

        #header-content {
            display: flex;
            flex-direction: column;
            margin-left: 0; /* 头像在 header 里处理 */
            flex: 1;
        }

        #header-content-primary-column {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
        }

        #purchase-amount {
            font-weight: 500;
        }

        #body {
            padding: 8px 16px;
            color: rgba(0,0,0,0.87);
        }

        /* 3. 礼物/舰长 (模拟 yt-live-chat-membership-item-renderer) */
        yt-live-chat-membership-item-renderer {
            display: block;
            margin: 4px 24px;
        }

        yt-live-chat-membership-item-renderer #card {
            display: flex;
            flex-direction: row;
            align-items: center;
            padding: 4px 8px;
            border-radius: 4px;
            color: rgba(0,0,0,0.87);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        yt-live-chat-membership-item-renderer #header {
            background-color: transparent !important; /* Reset, let CSS handle bg */
            padding: 0;
            display: flex;
            flex-direction: row;
            align-items: center;
            width: 100%;
        }

        yt-live-chat-membership-item-renderer #header-content {
             display: flex;
             flex-direction: column;
             margin-left: 16px;
        }

        /* 默认隐藏的元素，供 CSS 选择器使用 */
        yt-live-chat-header-renderer,
        yt-live-chat-message-input-renderer,
        yt-live-chat-ticker-renderer {
            display: none;
        }

        /* 注入用户提供的 CSS (基础变量) */
        html:not(.style-scope) {
            --yt-live-chat-background-color: #fff;
            --yt-live-chat-action-panel-background-color: hsla(0, 0%, 93%, .4);
            --yt-live-chat-action-panel-background-color-transparent: hsla(0, 0%, 97%, .8);
            --yt-live-chat-mode-change-background-color: hsla(0, 0%, 93%, .4);
            --yt-live-chat-primary-text-color: #111;
            --yt-live-chat-secondary-text-color: hsla(0, 0%, 7%, .6);
            --yt-live-chat-tertiary-text-color: hsla(0, 0%, 7%, .4);
            --yt-live-chat-text-input-field-inactive-underline-color: #b8b8b8;
            --yt-live-chat-text-input-field-placeholder-color: hsla(0, 0%, 7%, .6);
            --yt-live-chat-icon-button-color: hsla(0, 0%, 7%, .4);
            --yt-live-chat-enabled-send-button-color: #4285f4;
            --yt-live-chat-disabled-icon-button-color: hsla(0, 0%, 7%, .2);
            --yt-live-chat-picker-button-color: hsla(0, 0%, 7%, .4);
            --yt-live-chat-picker-button-active-color: hsla(0, 0%, 7%, .8);
            --yt-live-chat-picker-button-disabled-color: var(--yt-live-chat-disabled-icon-button-color);
            --yt-live-chat-picker-button-hover-color: hsla(0, 0%, 7%, .6);
            --yt-live-chat-mention-background-color: #ff5722;
            --yt-live-chat-mention-text-color: #fff;
            --yt-live-chat-deleted-message-color: rgba(0, 0, 0, .5);
            --yt-live-chat-deleted-message-bar-color: hsla(0, 0%, 4%, .2);
            --yt-live-chat-disabled-button-background-color: #eee;
            --yt-live-chat-disabled-button-text-color: hsla(0, 0%, 7%, .4);
            --yt-live-chat-sub-panel-background-color: #eee;
            --yt-live-chat-sub-panel-background-color-transparent: hsla(0, 0%, 93%, .7);
            --yt-live-chat-header-background-color: hsla(0, 0%, 93%, .4);
            --yt-live-chat-header-button-color: #111;
            --yt-live-chat-error-message-color: #bd523d;
            --yt-live-chat-reconnect-message-color: hsla(0, 0%, 7%, .2);
            --yt-live-chat-moderator-color: #5f84f1;
            --yt-live-chat-owner-color: #e3a935;
            --yt-live-chat-author-chip-owner-text-color: rgba(0, 0, 0, .87);
            --yt-live-chat-author-chip-verified-background-color: #ccc;
            --yt-live-chat-author-chip-verified-text-color: #606060;
            --yt-live-chat-message-highlight-background-color: #f8f8f8;
            --yt-live-chat-sponsor-color: #107516;
            --yt-live-chat-overlay-color: rgba(0, 0, 0, .6);
            --yt-live-chat-dialog-background-color: #fff;
            --yt-live-chat-dialog-text-color: hsla(0, 0%, 7%, .6);
            --yt-live-chat-poll-choice-text-color: var(--yt-spec-text-secondary);
            --yt-live-chat-poll-choice-border-color: var(--yt-spec-10-percent-layer);
            --yt-live-chat-poll-choice-vote-bar-background-color: hsla(0, 0%, 93%, .8);
            --yt-live-chat-poll-choice-vote-bar-background-color-selected: #f2f8ff;
            --yt-live-chat-poll-choice-color-selected: #065fd4;
            --yt-live-chat-moderation-mode-hover-background-color: hsla(0, 0%, 7%, .2);
            --yt-live-chat-additional-inline-action-button-color: #fff;
            --yt-live-chat-additional-inline-action-button-background-color: rgba(66, 66, 66, .8);
            --yt-live-chat-additional-inline-action-button-background-color-hover: #424242;
            --yt-formatted-string-emoji-size: 24px;
            --yt-live-chat-emoji-size: 24px;
            --yt-live-chat-text-input-field-suggestion-background-color: #fff;
            --yt-live-chat-text-input-field-suggestion-background-color-hover: #eee;
            --yt-live-chat-text-input-field-suggestion-text-color: #666;
            --yt-live-chat-text-input-field-suggestion-text-color-hover: #333;
            --yt-live-chat-ticker-arrow-background: #f8f8f8;
            --yt-emoji-picker-category-background-color: var(--yt-live-chat-action-panel-background-color-transparent);
            --yt-emoji-picker-category-color: var(--yt-live-chat-secondary-text-color);
            --yt-emoji-picker-category-button-color: var(--yt-live-chat-picker-button-color);
            --yt-emoji-picker-search-background-color: hsla(0, 0%, 100%, .6);
            --yt-emoji-picker-search-color: hsla(0, 0%, 7%, .8);
            --yt-emoji-picker-search-placeholder-color: hsla(0, 0%, 7%, .6);
            --yt-live-chat-slider-active-color: #2196f3;
            --yt-live-chat-slider-container-color: #c8c8c8;
            --yt-live-chat-slider-markers-color: #505050;
            --yt-live-chat-toast-background-color: #333;
            --yt-live-chat-toast-text-color: #fff;
            --yt-live-chat-automod-button-background-color: #eee;
            --yt-live-chat-automod-button-background-color-hover: hsla(0, 0%, 7%, .2);
            --yt-live-chat-countdown-opacity: 0.3;
            --yt-live-chat-shimmer-background-color: hsla(0, 0%, 53%, .2);
            --yt-live-chat-shimmer-linear-gradient: linear-gradient(0deg, hsla(0, 0%, 100%, 0) 40%, hsla(0, 0%, 100%, .5) 50%, hsla(0, 0%, 100%, 0) 65%);
            --yt-live-chat-vem-background-color: #eee;
            --yt-live-chat-upsell-dialog-renderer-button-padding: 10px 16px;
            --yt-live-chat-product-picker-icon-color: hsla(0, 0%, 7%, .6);
            --yt-live-chat-product-picker-hover-color: rgba(17, 17, 16, .1);
            --yt-live-chat-product-picker-disabled-icon-color: hsla(0, 0%, 7%, .4);
            --yt-pdg-paid-stickers-tab-selection-bar-color: #065fd4;
            --yt-pdg-paid-stickers-author-name-font-size: 13px;
            --yt-pdg-paid-stickers-margin-left: 38px;
        }
        
        /* 注入用户提供的 CSS (自定义外观) */
        @import url("https://fonts.googleapis.com/css?family=Noto%20Sans%20SC");
 
        /* Transparent background */ 
        yt-live-chat-renderer { 
            background-color: transparent !important; 
        } 
        
        yt-live-chat-ticker-renderer { 
            background-color: transparent !important; 
            box-shadow: none !important; 
        } 
        
        yt-live-chat-author-chip #author-name { 
            background-color: transparent !important; 
        } 
        
        /* Hide scrollbar */ 
        yt-live-chat-item-list-renderer #items { 
            overflow: hidden !important; 
        } 
        
        yt-live-chat-item-list-renderer #item-scroller { 
            overflow: hidden !important; 
        } 
        
        yt-live-chat-text-message-renderer #content, 
        yt-live-chat-membership-item-renderer #content { 
            overflow: visible !important; 
        } 
        
        /* Hide header and input */ 
        yt-live-chat-header-renderer, 
        yt-live-chat-message-input-renderer { 
            display: none !important; 
        } 
        
        /* Hide unimportant messages */ 
        yt-live-chat-text-message-renderer[is-deleted], 
        yt-live-chat-membership-item-renderer[is-deleted] { 
            display: none !important; 
        } 
        
        yt-live-chat-mode-change-message-renderer,  
        yt-live-chat-viewer-engagement-message-renderer,  
        yt-live-chat-restricted-participation-renderer { 
            display: none !important; 
        } 
        
        yt-live-chat-text-message-renderer a, 
        yt-live-chat-membership-item-renderer a { 
            text-decoration: none !important; 
        } 
        
        /* Reduce side padding */ 
        yt-live-chat-text-message-renderer { 
            padding-left: 4px !important; 
            padding-right: 4px !important; 
        } 
        
        /* Avatars */ 
        yt-live-chat-text-message-renderer #author-photo, 
        yt-live-chat-text-message-renderer #author-photo img, 
        yt-live-chat-paid-message-renderer #author-photo, 
        yt-live-chat-paid-message-renderer #author-photo img, 
        yt-live-chat-membership-item-renderer #author-photo, 
        yt-live-chat-membership-item-renderer #author-photo img { 
            
            width: 40px !important; 
            height: 40px !important; 
            border-radius: 40px !important; 
            margin-right: 10px !important; 
        } 
        
        /* Channel names */ 
        yt-live-chat-text-message-renderer yt-live-chat-author-chip { 
            margin-bottom: 5px; 
        } 
        
        yt-live-chat-text-message-renderer #author-name[type="owner"], 
        yt-live-chat-text-message-renderer yt-live-chat-author-badge-renderer[type="owner"] { 
            color: #ffd600 !important; 
        } 
        
        yt-live-chat-text-message-renderer #author-name[type="moderator"], 
        yt-live-chat-text-message-renderer yt-live-chat-author-badge-renderer[type="moderator"] { 
            color: #5e84f1 !important; 
        } 
        
        yt-live-chat-text-message-renderer #author-name[type="member"], 
        yt-live-chat-text-message-renderer yt-live-chat-author-badge-renderer[type="member"] { 
            color: #0f9d58 !important; 
        } 
        
        yt-live-chat-text-message-renderer #author-name { 
            
            color: #cccccc !important; 
            font-family: "Noto Sans SC", "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "\5FAE \8F6F \96C5 \9ED1 ", SimHei, Arial, sans-serif; 
            font-size: 20px !important; 
            line-height: 22px !important; 
        } 
        
        /* Hide badges */ 
        yt-live-chat-text-message-renderer #chat-badges { 
            
            vertical-align: text-top !important; 
        } 
        
        /* Messages */ 
        yt-live-chat-text-message-renderer #message, 
        yt-live-chat-text-message-renderer #message * { 
            color: #000000 !important; 
            font-family: "Noto Sans SC", "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "\5FAE \8F6F \96C5 \9ED1 ", SimHei, Arial, sans-serif; 
            font-size: 18px !important; 
            line-height: 20px !important; 
        } 
        
        yt-live-chat-text-message-renderer #message { 
            display: block !important; 
            position: relative; 
            width: fit-content; 
            overflow: visible !important; 
            padding: 15px; 
            border-radius: 24px; 
        } 
        
        yt-live-chat-text-message-renderer #message:has(.emoji.blc-large-emoji) { 
            
        } 
        
        yt-live-chat-text-message-renderer #message .emoji { 
            width: auto !important; 
            height: 18px !important; 
        } 
        
        yt-live-chat-text-message-renderer #message .emoji.blc-large-emoji { 
            height: 36px !important; 
        } 
        
        /* The triangle beside dialog */ 
        yt-live-chat-text-message-renderer #message::before { 
            content: ""; 
            display: inline-block; 
            position: absolute; 
            top: -3px; 
            left: -10px; 
            border: 8px solid transparent; 
            border-right: 18px solid; 
            transform: rotate(35deg); 
        } 
        
        yt-live-chat-text-message-renderer #message:has(.emoji.blc-large-emoji)::before { 
            
        } 
        
        
        
        /* Timestamps */ 
        yt-live-chat-text-message-renderer #timestamp { 
            display: none !important; 
            color: #999999 !important; 
            font-family: "Noto Sans SC", "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "\5FAE \8F6F \96C5 \9ED1 ", SimHei, Arial, sans-serif; 
            font-size: 16px !important; 
            line-height: 16px !important; 
        } 
        
        /* Background colors */ 
        body { 
            overflow: hidden; 
            background-color: rgba(0, 0, 0, 0); 
        } 
        
        yt-live-chat-text-message-renderer #message { 
            background-color: #ffffff !important; 
        } 
        
        yt-live-chat-text-message-renderer #message::before { 
            border-right-color: #ffffff; 
        } 
        
        yt-live-chat-text-message-renderer[author-type="owner"] #message { 
            background-color: rgba(231, 199, 30, 1) !important; 
        } 
        
        yt-live-chat-text-message-renderer[author-type="owner"] #message::before { 
            border-right-color: rgba(231, 199, 30, 1); 
        } 
        
        yt-live-chat-text-message-renderer[author-type="moderator"] #message { 
            background-color: rgba(41, 95, 251, 1) !important; 
        } 
        
        yt-live-chat-text-message-renderer[author-type="moderator"] #message::before { 
            border-right-color: rgba(41, 95, 251, 1); 
        } 
        
        yt-live-chat-text-message-renderer[author-type="member"] #message { 
            background-color: rgba(43, 234, 43, 1) !important; 
        } 
        
        yt-live-chat-text-message-renderer[author-type="member"] #message::before { 
            border-right-color: rgba(43, 234, 43, 1); 
        } 
        
        yt-live-chat-text-message-renderer #message:has(.emoji.blc-large-emoji) { 
            
        } 
        
        /* SuperChat/Fan Funding Messages */ 
        yt-live-chat-paid-message-renderer { 
            margin: 4px 0 !important; 
        } 
        
        yt-live-chat-paid-message-renderer #author-name, 
        yt-live-chat-paid-message-renderer #author-name *, 
        yt-live-chat-membership-item-renderer #header-content-inner-column, 
        yt-live-chat-membership-item-renderer #header-content-inner-column * { 
            font-family: "Noto Sans SC", "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "\5FAE \8F6F \96C5 \9ED1 ", SimHei, Arial, sans-serif; 
            font-size: 20px !important; 
            line-height: 22px !important; 
        } 
        
        yt-live-chat-paid-message-renderer #purchase-amount, 
        yt-live-chat-paid-message-renderer #purchase-amount *, 
        yt-live-chat-membership-item-renderer #header-subtext, 
        yt-live-chat-membership-item-renderer #header-subtext * { 
            font-family: "Noto Sans SC", "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "\5FAE \8F6F \96C5 \9ED1 ", SimHei, Arial, sans-serif; 
            font-size: 18px !important; 
            line-height: 20px !important; 
        } 
        
        yt-live-chat-paid-message-renderer #content, 
        yt-live-chat-paid-message-renderer #content * { 
            font-family: "Noto Sans SC", "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "\5FAE \8F6F \96C5 \9ED1 ", SimHei, Arial, sans-serif; 
            font-size: 18px !important; 
            line-height: 20px !important; 
        } 
        
        yt-live-chat-membership-item-renderer #card, 
        yt-live-chat-membership-item-renderer #header { 
            background-color: #0f9d58 !important; 
            margin: 4px 0 !important; 
        } 
        
        yt-live-chat-ticker-renderer { 
            display: none !important; 
        } 
        
        /* SuperChat Ticker */ 
        yt-live-chat-ticker-paid-message-item-renderer, 
        yt-live-chat-ticker-paid-message-item-renderer *, 
        yt-live-chat-ticker-sponsor-item-renderer, 
        yt-live-chat-ticker-sponsor-item-renderer * { 
            font-family: "Noto Sans SC", "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "\5FAE \8F6F \96C5 \9ED1 ", SimHei, Arial, sans-serif; 
        } 
        
        
        
        /* Animation */ 
        @keyframes anim { 
            0% { opacity: 0; transform: translateX(-16px); } 
            100% { opacity: 1; transform: none; } 
        } 
        
        yt-live-chat-item-list-renderer #items > * { 
            animation: anim 200ms; 
            animation-fill-mode: both; 
        }
    </style>
</head>
<body>
    <yt-live-chat-renderer>
        <yt-live-chat-item-list-renderer>
            <div id="items">
                <!-- 消息将插入到这里 -->
            </div>
        </yt-live-chat-item-list-renderer>
    </yt-live-chat-renderer>

    <script>
        const socket = io('http://localhost:18888', {
            transports: ['websocket'],
            reconnection: true
        });

        const itemsContainer = document.getElementById('items');

        // 配置：最大消息数
        const MAX_MESSAGES = 50;

        function addElement(element) {
            itemsContainer.appendChild(element);
            // 自动滚动到底部
            window.scrollTo(0, document.body.scrollHeight);
            
            // 移除旧消息
            if (itemsContainer.children.length > MAX_MESSAGES) {
                itemsContainer.removeChild(itemsContainer.children[0]);
            }
        }

        // 辅助：生成头像 HTML
        function createAvatar(url) {
            // 结构: <yt-img-shadow id="author-photo" class="style-scope yt-live-chat-text-message-renderer" ...><img id="img" class="style-scope yt-img-shadow" ...></yt-img-shadow>
            const div = document.createElement('yt-img-shadow');
            div.id = 'author-photo';
            div.className = 'no-transition style-scope yt-live-chat-text-message-renderer';
            // 默认尺寸 24，但 CSS 会强制改为 40
            div.setAttribute('height', '24'); 
            div.setAttribute('width', '24');
            
            const img = document.createElement('img');
            img.id = 'img';
            img.className = 'style-scope yt-img-shadow';
            
            // 默认头像
            const DEFAULT_FACE = '//static.hdslb.com/images/member/noface.gif';
            const validUrl = (url && url.startsWith('http')) ? url : DEFAULT_FACE;
            
            img.src = validUrl;
            img.width = 24;
            img.height = 24;
            img.alt = '';
            
            // 只有当 URL 不是默认头像时才监听错误，防止死循环闪烁
            if (validUrl !== DEFAULT_FACE) {
                img.onerror = () => {
                    if (img.src !== DEFAULT_FACE) {
                        img.src = DEFAULT_FACE;
                    }
                };
            }
            
            div.appendChild(img);
            return div;
        }

        // 辅助：生成作者名 HTML
        function createAuthorChip(uname, type = '') {
            const chip = document.createElement('yt-live-chat-author-chip');
            const name = document.createElement('span');
            name.id = 'author-name';
            name.innerText = uname;
            if (type) name.setAttribute('type', type); // owner, moderator, member
            chip.appendChild(name);
            // 这里可以加徽章逻辑
            return chip;
        }

        socket.on('danmu-message', (msg) => {
            console.log('MSG:', msg);

            // 1. 普通弹幕 (DANMU_MSG)
            if (msg.cmd === 'DANMU_MSG') {
                const info = msg.info;
                const uname = info[2][1];
                const content = info[1];
                const uid = info[2][0];
                const isGuard = info[7] > 0;
                const isAdmin = info[2][2] === 1;
                
                // 尝试获取注入的 face，如果没有则用默认
                // 后端逻辑：第一次发弹幕可能没有 face（正在取），第二次就会有了
                // 默认头像
                const DEFAULT_FACE = '//static.hdslb.com/images/member/noface.gif';
                const face = msg.face || DEFAULT_FACE; 

                // <yt-live-chat-text-message-renderer class="style-scope yt-live-chat-item-list-renderer" ...>
                const el = document.createElement('yt-live-chat-text-message-renderer');
                el.className = 'style-scope yt-live-chat-item-list-renderer';
                if (isAdmin) el.setAttribute('author-type', 'moderator');
                else if (isGuard) el.setAttribute('author-type', 'member');
                
                // 1. 头像
                el.appendChild(createAvatar(face));

                // 2. 内容容器 <div id="content" class="style-scope yt-live-chat-text-message-renderer">
                const contentDiv = document.createElement('div');
                contentDiv.id = 'content';
                contentDiv.className = 'style-scope yt-live-chat-text-message-renderer';
                
                contentDiv.appendChild(createAuthorChip(uname, isAdmin ? 'moderator' : (isGuard ? 'member' : '')));
                
                const messageSpan = document.createElement('span');
                messageSpan.id = 'message';
                messageSpan.innerText = content;
                contentDiv.appendChild(messageSpan);

                el.appendChild(contentDiv);
                addElement(el);
            }

            // 2. 礼物 (SEND_GIFT)
            else if (msg.cmd === 'SEND_GIFT') {
                const data = msg.data;
                // 筛选：比如只显示大于等于 1 元的礼物
                // if (data.coin_type === 'gold' && data.total_coin < 1000) return; 

                const el = document.createElement('yt-live-chat-membership-item-renderer');
                
                const card = document.createElement('div');
                card.id = 'card';
                
                const header = document.createElement('div');
                header.id = 'header';
                
                header.appendChild(createAvatar(data.face));
                
                const headerContent = document.createElement('div');
                headerContent.id = 'header-content';
                
                const authorName = document.createElement('div');
                authorName.id = 'header-content-inner-column';
                authorName.innerText = data.uname;
                
                const subtext = document.createElement('div');
                subtext.id = 'header-subtext';
                subtext.innerText = `投喂 ${data.giftName} x${data.num}`;
                
                headerContent.appendChild(authorName);
                headerContent.appendChild(subtext);
                header.appendChild(headerContent);
                
                card.appendChild(header);
                el.appendChild(card);
                addElement(el);
            }

            // 3. 舰长 (USER_TOAST_MSG)
            else if (msg.cmd === 'USER_TOAST_MSG') {
                const data = msg.data;
                const el = document.createElement('yt-live-chat-membership-item-renderer'); // 复用 Membership 样式
                
                const card = document.createElement('div');
                card.id = 'card';
                card.style.backgroundColor = '#00a1d6'; // 舰长蓝，会被 CSS 覆盖
                
                const header = document.createElement('div');
                header.id = 'header';
                
                header.appendChild(createAvatar(data.face)); // 你的后端已经注入了 face
                
                const headerContent = document.createElement('div');
                headerContent.id = 'header-content';
                
                const authorName = document.createElement('div');
                authorName.id = 'header-content-inner-column';
                authorName.innerText = data.username;
                
                const subtext = document.createElement('div');
                subtext.id = 'header-subtext';
                const guardName = data.guard_level === 1 ? '总督' : (data.guard_level === 2 ? '提督' : '舰长');
                subtext.innerText = `开通了 ${guardName} x${data.num}${data.unit}`;
                
                headerContent.appendChild(authorName);
                headerContent.appendChild(subtext);
                header.appendChild(headerContent);
                
                card.appendChild(header);
                el.appendChild(card);
                addElement(el);
            }

            // 4. SuperChat (SUPER_CHAT_MESSAGE)
            else if (msg.cmd === 'SUPER_CHAT_MESSAGE') {
                const data = msg.data;
                const el = document.createElement('yt-live-chat-paid-message-renderer');
                
                // 设置 SC 颜色等级 (模拟 YouTube 颜色逻辑)
                const price = data.price;
                let colorStyle = '';
                // 简单分级
                if (price >= 2000) el.style.setProperty('--yt-live-chat-paid-message-primary-color', '#d00000'); // Red
                else if (price >= 1000) el.style.setProperty('--yt-live-chat-paid-message-primary-color', '#e62117'); // Magenta
                else if (price >= 500) el.style.setProperty('--yt-live-chat-paid-message-primary-color', '#e62117'); // Orange
                else if (price >= 100) el.style.setProperty('--yt-live-chat-paid-message-primary-color', '#ffb300'); // Yellow
                else el.style.setProperty('--yt-live-chat-paid-message-primary-color', '#1565c0'); // Blue
                
                // Header
                const card = document.createElement('div');
                card.id = 'card';
                
                const header = document.createElement('div');
                header.id = 'header';
                // header 颜色通常比 body 深一点，这里简化，CSS 可以统一处理
                header.style.backgroundColor = 'var(--yt-live-chat-paid-message-primary-color)';
                
                header.appendChild(createAvatar(data.user_info.face));
                
                const headerContent = document.createElement('div');
                headerContent.id = 'header-content';
                const primaryCol = document.createElement('div');
                primaryCol.id = 'header-content-primary-column';
                
                const name = document.createElement('div');
                name.id = 'author-name';
                name.innerText = data.user_info.uname;
                
                const amount = document.createElement('div');
                amount.id = 'purchase-amount';
                amount.innerText = `￥${price}`;
                
                primaryCol.appendChild(name);
                primaryCol.appendChild(amount);
                headerContent.appendChild(primaryCol);
                header.appendChild(headerContent);
                
                // Body
                const body = document.createElement('div');
                body.id = 'body';
                body.style.backgroundColor = 'var(--yt-live-chat-paid-message-secondary-color, #1565c0)'; // 简单 fallback
                
                const message = document.createElement('div');
                message.id = 'message';
                message.innerText = data.message;
                
                body.appendChild(message);
                
                card.appendChild(header);
                card.appendChild(body);
                el.appendChild(card);
                addElement(el);
            }
        });
    </script>
</body>
</html>
</body>
</html>
