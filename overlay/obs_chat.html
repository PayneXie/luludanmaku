<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="referrer" content="no-referrer" />
    <title>OBS Chat - WeChat Style</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Jost:ital,wght@0,400;0,600;1,400;1,600&display=swap');

        :root {
            --font-stack: 'Jost', "MiSans Regular", "MiSans", sans-serif;
            --bg-color: transparent;
            --gap: 12px;
            --avatar-size: 44px;
            
            /* Bubble Colors */
            --bubble-purple: rgb(233, 204, 240); /* Level 2 - Admiral */
            --bubble-blue: rgb(200, 221, 252);   /* Level 3 - Captain */
            --bubble-orange: rgb(253, 213, 186); /* Level 1 - Governor */
            --bubble-white: #f1fbf5;             /* Normal - Mint White */
            --bubble-grey: #F5F5F5;
            
            /* Text Colors */
            --text-primary: #191919;
            --text-secondary: #888888;
            --name-color: #333333; /* Normal user - Black/Dark Grey */
            
            /* Guard Name Colors (Matching Console/User Description) */
            --name-guard-3: #5896DE; /* Captain - Blue */
            --name-guard-2: #9C27B0; /* Admiral - Deep Purple */
            --name-guard-1: #BB8613; /* Governor - Deep Gold */
            
            /* SC Colors (Console Match) */
            /* Level 0: < 50 */
            --sc-0-body: #2a60b2; --sc-0-header: #dcebff; --sc-0-text: #ffffff; --sc-0-header-text: #333333;
            /* Level 1: 50-99 */
            --sc-1-body: #427d9e; --sc-1-header: #e0eff5; --sc-1-text: #ffffff; --sc-1-header-text: #333333;
            /* Level 2: 100-499 */
            --sc-2-body: #f2c060; --sc-2-header: #fff8e6; --sc-2-text: #6d4c09; --sc-2-header-text: #6d4c09;
            /* Level 3: 500-999 */
            --sc-3-body: #f59654; --sc-3-header: #fff0e3; --sc-3-text: #ffffff; --sc-3-header-text: #333333;
            /* Level 4: 1000-1999 */
            --sc-4-body: #f76868; --sc-4-header: #ffebeb; --sc-4-text: #ffffff; --sc-4-header-text: #333333;
            /* Level 5: > 2000 */
            --sc-5-body: #c42742; --sc-5-header: #fcebeb; --sc-5-text: #ffffff; --sc-5-header-text: #333333;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            font-family: var(--font-stack);
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        .chat-container {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: calc(100% - 40px);
            max-width: 600px;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            gap: 16px;
            pointer-events: none; /* Let clicks pass through if needed */
        }

        /* Animations */
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeOut {
            from { opacity: 1; transform: scale(1); max-height: 500px; margin-bottom: var(--gap); }
            to { opacity: 0; transform: scale(0.9); max-height: 0; margin-bottom: 0; }
        }

        .chat-item {
            pointer-events: auto; /* Re-enable clicks on items */
            display: flex;
            flex-direction: row;
            align-items: flex-start;
            gap: var(--gap);
            animation: slideIn 0.4s cubic-bezier(0.25, 1, 0.5, 1) forwards;
            transform-origin: left bottom;
            width: 100%; /* Full width for SC cards */
        }

        .chat-item.removing {
            animation: fadeOut 0.4s cubic-bezier(0.25, 1, 0.5, 1) forwards;
            pointer-events: none;
        }

        /* Avatar */
        .avatar {
            width: var(--avatar-size);
            height: var(--avatar-size);
            flex-shrink: 0;
            border-radius: 6px; /* Rounded square like WeChat */
            overflow: hidden;
            background: #eee;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Content Column */
        .content {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            max-width: calc(100% - var(--avatar-size) - var(--gap));
            flex: 1; /* Allow growing */
        }

        /* Header: Name + Icon only */
        .header {
            display: flex;
            align-items: center;
            gap: 8px; /* Increased gap */
            margin-bottom: 4px;
            font-size: 13px;
            line-height: 1.2;
        }

        .name {
            color: var(--name-color);
            font-weight: bold; /* Ensure name is bold too */
            font-size: 16px; /* Slightly larger name */
        }
        
        .name.guard-3 { color: var(--name-guard-3); }
        .name.guard-2 { color: var(--name-guard-2); }
        .name.guard-1 { color: var(--name-guard-1); }

        /* Standalone Guard Icons (No Badge Box) */
        .icon-guard {
            display: inline-block;
            width: 24px; /* Slightly larger as requested */
            height: 24px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            vertical-align: middle;
        }
        
        /* Admin/Manager Icon */
        .icon-admin {
            display: inline-block;
            width: 18px;
            height: 18px;
            vertical-align: middle;
            margin-right: 2px;
            fill: #ff9800;
        }

        /* Message Bubble */
        .bubble {
            position: relative;
            padding: 10px 14px;
            border-radius: 6px;
            font-size: 17px; /* Increased from 15px */
            line-height: 1.5;
            color: var(--text-primary);
            word-wrap: break-word;
            max-width: 100%;
            box-shadow: 0 1px 1px rgba(0,0,0,0.05);
            font-weight: bold; /* Bold text as requested */
        }
        
        /* Triangle Pointer */
        .bubble::before {
            content: "";
            position: absolute;
            left: -6px;
            top: 14px;
            width: 0;
            height: 0;
            border-top: 6px solid transparent;
            border-bottom: 6px solid transparent;
            border-right: 6px solid var(--bubble-bg, #fff);
        }

        /* Bubble Variants */
        .bubble.variant-purple { 
            background-color: var(--bubble-purple); 
            --bubble-bg: var(--bubble-purple);
        }
        .bubble.variant-blue { 
            background-color: var(--bubble-blue); 
            --bubble-bg: var(--bubble-blue);
        }
        .bubble.variant-orange { 
            background-color: var(--bubble-orange); 
            --bubble-bg: var(--bubble-orange);
        }
        .bubble.variant-white { 
            background-color: var(--bubble-white); 
            --bubble-bg: var(--bubble-white);
            border: 1px solid #ededed;
        }
        .bubble.variant-grey { 
            background-color: var(--bubble-grey); 
            --bubble-bg: var(--bubble-grey);
        }

        /* SC Card Styles */
        .sc-card {
            width: 100%;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            font-weight: bold;
            display: flex;
            flex-direction: column;
        }
        
        .sc-header {
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            background-color: var(--sc-header-bg);
            color: var(--sc-header-text);
        }
        
        .sc-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.5);
        }
        
        .sc-info {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .sc-name {
            font-size: 16px; /* Larger */
            font-weight: bold; /* Bold */
            opacity: 1;
        }
        
        .sc-price {
            font-size: 16px; /* Larger */
            font-weight: bold;
        }
        
        .sc-body {
            padding: 12px;
            font-size: 17px;
            line-height: 1.4;
            background-color: var(--sc-body-bg);
            color: var(--sc-body-text);
            word-wrap: break-word;
        }

        /* Gift Styles */
        /* Small Gift: Inline Bubble Style */
        .bubble.variant-gift-small {
            background-color: #fff0f6; /* Light Pink */
            border: 1px solid #ffadd2;
            color: #c41d7f;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        /* Remove triangle pointer for small gift bubbles */
        .bubble.variant-gift-small::before {
            display: none !important;
        }

        .gift-icon-small {
            width: 24px;
            height: 24px;
            object-fit: contain;
        }

        /* Large Gift: Card Style (Similar to SC) */
        .gift-card {
            width: 100%;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            font-weight: bold;
            display: flex;
            flex-direction: row;
            align-items: center;
            padding: 10px;
            color: white;
            position: relative;
        }

        .gift-card.price-high {
            background: linear-gradient(135deg, #ffec3d 0%, #faad14 100%); /* Gold for > 99 */
            color: #613400;
        }

        .gift-card.price-mid {
            background: linear-gradient(135deg, #ffadd2 0%, #eb2f96 100%); /* Pink for 30-99 */
            color: white;
        }

        .gift-card-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.8);
            margin-right: 12px;
        }

        .gift-card-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .gift-card-name {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 2px;
        }

        .gift-card-action {
            font-size: 16px;
        }

        .gift-card-icon {
            width: 48px;
            height: 48px;
            object-fit: contain;
            margin-left: 12px;
        }
        
        /* Guard Card Styles */
        .guard-card {
            width: 100%;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            font-weight: bold;
            display: flex;
            flex-direction: row;
            align-items: center;
            padding: 12px;
            color: white;
            position: relative;
            animation: slideIn 0.4s cubic-bezier(0.25, 1, 0.5, 1) forwards;
        }

        .guard-card.level-3 { background-color: #6D92E3; } /* Captain Blue */
        .guard-card.level-2 { background-color: #E386B0; } /* Admiral Pink */
        .guard-card.level-1 { background-color: #E89F43; } /* Governor Orange */

        .guard-card-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.9);
            margin-right: 12px;
        }

        .guard-card-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .guard-card-title {
            font-size: 18px;
            line-height: 1.2;
            margin-bottom: 4px;
        }

        .guard-card-name {
            font-size: 14px;
            opacity: 0.9;
        }

        .guard-card-icon {
            width: 56px;
            height: 56px;
            object-fit: contain;
            margin-left: 8px;
            opacity: 0.9;
        }

        /* SC Level Variants */
        .sc-level-0 { --sc-header-bg: var(--sc-0-header); --sc-body-bg: var(--sc-0-body); --sc-body-text: var(--sc-0-text); --sc-header-text: var(--sc-0-header-text); }
        .sc-level-1 { --sc-header-bg: var(--sc-1-header); --sc-body-bg: var(--sc-1-body); --sc-body-text: var(--sc-1-text); --sc-header-text: var(--sc-1-header-text); }
        .sc-level-2 { --sc-header-bg: var(--sc-2-header); --sc-body-bg: var(--sc-2-body); --sc-body-text: var(--sc-2-text); --sc-header-text: var(--sc-2-header-text); }
        .sc-level-3 { --sc-header-bg: var(--sc-3-header); --sc-body-bg: var(--sc-3-body); --sc-body-text: var(--sc-3-text); --sc-header-text: var(--sc-3-header-text); }
        .sc-level-4 { --sc-header-bg: var(--sc-4-header); --sc-body-bg: var(--sc-4-body); --sc-body-text: var(--sc-4-text); --sc-header-text: var(--sc-4-header-text); }
        .sc-level-5 { --sc-header-bg: var(--sc-5-header); --sc-body-bg: var(--sc-5-body); --sc-body-text: var(--sc-5-text); --sc-header-text: var(--sc-5-header-text); }

        /* Emotes inside text */
        .emote {
            height: 24px;
            vertical-align: text-bottom;
            margin: 0 2px;
        }

        /* Large Sticker */
        .sticker {
            max-width: 60px; /* Reduced from 120px */
            border-radius: 4px;
            display: block;
        }
    </style>
</head>
<body>

<div class="chat-container" id="chat-box">
    <!-- WebSocket Messages will be injected here -->
</div>

<script>
    // --- WebSocket Integration ---
    const socket = io('http://localhost:18888', {
        transports: ['websocket'],
        reconnection: true
    });

    const chatBox = document.getElementById('chat-box');
    const DEFAULT_FACE = 'https://i0.hdslb.com/bfs/face/member/noface.jpg';
    const SHOW_INTERACT = true; // Config: Show interact/follow messages?

    // Message Queue
    const messageQueue = [];
    let isProcessing = false;

    // --- Helper: Process Queue (Batching) ---
    function processQueue() {
        if (messageQueue.length === 0) {
            isProcessing = false;
            return;
        }

        isProcessing = true;
        
        // Process batch
        const BATCH_SIZE = 5;
        const batch = messageQueue.splice(0, BATCH_SIZE);
        
        batch.forEach(msg => {
            const formattedMsg = parseBilibiliMessage(msg);
            if (formattedMsg) {
                addMessage(formattedMsg);
            }
        });

        // Continue
        requestAnimationFrame(processQueue);
    }

    // --- Socket Listeners ---
    socket.on('danmu-message', (msg) => {
        messageQueue.push(msg);
        if (!isProcessing) {
            processQueue();
        }
    });

    // --- Message Parser: Bilibili Protocol -> Internal Format ---
    function parseBilibiliMessage(msg) {
        try {
            // 1. Normal Danmaku
            if (msg.cmd === 'DANMU_MSG') {
                const info = msg.info;
                const uname = info[2][1];
                const content = info[1];
                const guardLevel = info[7];
                const isManager = info[2][2] === 1; // 0: Normal, 1: Manager
                const face = msg.face || DEFAULT_FACE;
                const isEmoji = info[0][13] && info[0][13].url;
                
                // Construct HTML content for emoji/text
                let htmlContent = content;
                if (isEmoji) {
                    htmlContent = `<img src="${info[0][13].url}" class="sticker">`;
                }

                return {
                    type: 'chat',
                    name: uname,
                    avatar: face,
                    content: htmlContent,
                    guard: guardLevel,
                    isManager: isManager
                };
            }

            // 2. Super Chat
            else if (msg.cmd === 'SUPER_CHAT_MESSAGE') {
                const data = msg.data;
                let level = 0;
                if (data.price >= 2000) level = 5;
                else if (data.price >= 1000) level = 4;
                else if (data.price >= 500) level = 3;
                else if (data.price >= 100) level = 2;
                else if (data.price >= 50) level = 1;
                
                return {
                    type: 'super-chat',
                    name: data.user_info?.uname,
                    avatar: data.user_info?.face,
                    price: data.price,
                    content: data.message,
                    level: level
                };
            }

            // 3. Gift
            else if (msg.cmd === 'SEND_GIFT' || msg.cmd === 'COMBO_SEND') {
                const data = msg.data;
                
                // Extract Gift Icon
                let iconUrl = 'https://s1.hdslb.com/bfs/live/a02092c2866952402685764d0d36746f363c4739.png'; // Fallback
                
                // 1. Check data.gift_info (User mentioned this structure)
                if (data.gift_info && (data.gift_info.webp || data.gift_info.img_basic)) {
                    iconUrl = data.gift_info.webp || data.gift_info.img_basic;
                }
                // 2. Check batch_combo_send (Common in COMBO_SEND)
                else if (data.batch_combo_send && data.batch_combo_send.gift_info && (data.batch_combo_send.gift_info.webp || data.batch_combo_send.gift_info.img_basic)) {
                    iconUrl = data.batch_combo_send.gift_info.webp || data.batch_combo_send.gift_info.img_basic;
                }

                return {
                    type: 'gift',
                    name: data.uname,
                    avatar: data.face,
                    giftName: data.giftName,
                    giftIcon: iconUrl,
                    price: (data.price || 0) / 1000, 
                    num: data.num || data.batch_combo_num || 1
                };
            }

            // 4. Guard Buy
            else if (msg.cmd === 'USER_TOAST_MSG') {
                const data = msg.data;
                return {
                    type: 'guard-buy',
                    name: data.username,
                    avatar: data.face || DEFAULT_FACE,
                    guardLevel: data.guard_level,
                    num: data.num
                };
            }

            // 5. Interact (Optional)
            else if (msg.cmd === 'INTERACT_WORD' && SHOW_INTERACT) {
                // ... logic for interact if needed ...
                return null; // Skip for now to keep clean
            }

        } catch (e) {
            console.error('Parse error:', e);
            return null;
        }
        return null;
    }

    // --- Render Logic (Same as WeChat Mock but using real data) ---
    function addMessage(msg) {
        const item = document.createElement('div');
        item.className = 'chat-item'; 

        // 1. SuperChat
        if (msg.type === 'super-chat') {
            const scCard = document.createElement('div');
            scCard.className = `sc-card sc-level-${msg.level}`;
            
            const header = document.createElement('div');
            header.className = 'sc-header';
            
            const avatar = document.createElement('img');
            avatar.src = msg.avatar || DEFAULT_FACE;
            avatar.className = 'sc-avatar';
            header.appendChild(avatar);
            
            const info = document.createElement('div');
            info.className = 'sc-info';
            
            const name = document.createElement('div');
            name.className = 'sc-name';
            name.innerText = msg.name;
            info.appendChild(name);
            
            const price = document.createElement('div');
            price.className = 'sc-price';
            price.innerText = `CN¥${msg.price}`;
            info.appendChild(price);
            
            header.appendChild(info);
            scCard.appendChild(header);
            
            const body = document.createElement('div');
            body.className = 'sc-body';
            body.innerText = msg.content;
            scCard.appendChild(body);
            
            item.appendChild(scCard);
            chatBox.appendChild(item);
            cleanUpMessages();
            return;
        }

        // 2. Gift
        if (msg.type === 'gift') {
            // Check if big gift ( > 29 RMB )
            // Note: msg.price here needs to be RMB.
            // If backend passes 1000 for 1 RMB, divide by 1000.
            // Let's assume input price is RMB for now.
            const totalRMB = (msg.price || 0) * msg.num;
            const isBig = totalRMB > 29;
            
            if (isBig) {
                const giftCard = document.createElement('div');
                giftCard.className = `gift-card ${totalRMB > 99 ? 'price-high' : 'price-mid'}`;
                
                const avatar = document.createElement('img');
                avatar.src = msg.avatar || DEFAULT_FACE;
                avatar.className = 'gift-card-avatar';
                giftCard.appendChild(avatar);
                
                const content = document.createElement('div');
                content.className = 'gift-card-content';
                
                const name = document.createElement('div');
                name.className = 'gift-card-name';
                name.innerText = msg.name;
                content.appendChild(name);
                
                const action = document.createElement('div');
                action.className = 'gift-card-action';
                action.innerHTML = `投喂 <span>${msg.giftName}</span> x${msg.num} <span style="font-size:0.9em; opacity:0.8; margin-left:4px;">(CN¥${totalRMB.toFixed(1)})</span>`;
                content.appendChild(action);
                
                giftCard.appendChild(content);
                
                const icon = document.createElement('img');
                icon.src = msg.giftIcon;
                icon.className = 'gift-card-icon';
                // Fallback icon
                icon.onerror = () => { icon.style.display = 'none'; };
                giftCard.appendChild(icon);
                
                item.appendChild(giftCard);
            } else {
                // Small Gift Bubble
                const avatarDiv = document.createElement('div');
                avatarDiv.className = 'avatar';
                avatarDiv.innerHTML = `<img src="${msg.avatar || DEFAULT_FACE}">`;
                item.appendChild(avatarDiv);
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'content';
                
                const header = document.createElement('div');
                header.className = 'header';
                const nameSpan = document.createElement('span');
                nameSpan.className = 'name';
                nameSpan.innerText = msg.name;
                header.appendChild(nameSpan);
                contentDiv.appendChild(header);
                
                const bubble = document.createElement('div');
                bubble.className = 'bubble variant-gift-small';
                bubble.innerHTML = `
                    <span>投喂</span>
                    <img src="${msg.giftIcon}" class="gift-icon-small" onerror="this.style.display='none'">
                    <span>${msg.giftName} x${msg.num}</span>
                    <span style="font-size:0.9em; opacity:0.6; margin-left:2px;">(CN¥${totalRMB.toFixed(1)})</span>
                `;
                contentDiv.appendChild(bubble);
                item.appendChild(contentDiv);
            }
            
            chatBox.appendChild(item);
            cleanUpMessages();
            return;
        }

        // 3. Guard Buy
        if (msg.type === 'guard-buy') {
            const guardCard = document.createElement('div');
            guardCard.className = `guard-card level-${msg.guardLevel}`;
            
            const avatar = document.createElement('img');
            avatar.src = msg.avatar || DEFAULT_FACE;
            avatar.className = 'guard-card-avatar';
            guardCard.appendChild(avatar);
            
            const content = document.createElement('div');
            content.className = 'guard-card-content';
            
            const title = document.createElement('div');
            title.className = 'guard-card-title';
            const guardName = msg.guardLevel === 1 ? '总督' : (msg.guardLevel === 2 ? '提督' : '舰长');
            title.innerHTML = `欢迎 <span>${msg.name}</span> 开通 ${guardName}`;
            content.appendChild(title);
            
            const sub = document.createElement('div');
            sub.className = 'guard-card-name';
            sub.innerText = `${msg.num} 个月`;
            content.appendChild(sub);
            
            guardCard.appendChild(content);
            
            const icon = document.createElement('img');
            if (msg.guardLevel === 3) icon.src = 'https://i0.hdslb.com/bfs/activity-plat/static/20211222/627754775478985e330c25a90ec7baf0/icon-guard3.png@44w_44h.webp';
            else if (msg.guardLevel === 2) icon.src = 'https://i0.hdslb.com/bfs/activity-plat/static/20211222/627754775478985e330c25a90ec7baf0/icon-guard2.png@44w_44h.webp';
            else if (msg.guardLevel === 1) icon.src = 'https://i0.hdslb.com/bfs/activity-plat/static/20211222/627754775478985e330c25a90ec7baf0/icon-guard1.png@44w_44h.webp';
            
            icon.className = 'guard-card-icon';
            guardCard.appendChild(icon);
            
            item.appendChild(guardCard);
            chatBox.appendChild(item);
            cleanUpMessages();
            return;
        }

        // 4. Normal Chat
        // Avatar
        const avatarDiv = document.createElement('div');
        avatarDiv.className = 'avatar';
        avatarDiv.innerHTML = `<img src="${msg.avatar || DEFAULT_FACE}">`;
        item.appendChild(avatarDiv);

        // Content
        const contentDiv = document.createElement('div');
        contentDiv.className = 'content';

        // Header
        const header = document.createElement('div');
        header.className = 'header';
        
        const nameSpan = document.createElement('span');
        nameSpan.className = 'name';
        if (msg.guard > 0) nameSpan.classList.add(`guard-${msg.guard}`);
        nameSpan.innerText = msg.name;
        header.appendChild(nameSpan);

        // Guard Icon
        if (msg.guard > 0) {
            const iconImg = document.createElement('img');
            iconImg.className = 'icon-guard';
            if (msg.guard === 3) iconImg.src = 'https://i0.hdslb.com/bfs/activity-plat/static/20211222/627754775478985e330c25a90ec7baf0/icon-guard3.png@44w_44h.webp';
            else if (msg.guard === 2) iconImg.src = 'https://i0.hdslb.com/bfs/activity-plat/static/20211222/627754775478985e330c25a90ec7baf0/icon-guard2.png@44w_44h.webp';
            else if (msg.guard === 1) iconImg.src = 'https://i0.hdslb.com/bfs/activity-plat/static/20211222/627754775478985e330c25a90ec7baf0/icon-guard1.png@44w_44h.webp';
            header.appendChild(iconImg);
        }

        // Manager Icon
        if (msg.isManager) {
            // Simple Wrench SVG
            const adminIcon = document.createElement('span');
            adminIcon.className = 'icon-admin';
            adminIcon.innerHTML = `<svg viewBox="0 0 24 24" style="width:100%;height:100%;fill:#ff9800"><path d="M22.7,19L13.6,9.9C14.5,7.6 14,4.9 12.1,3C10.1,1 7.1,0.6 4.7,1.7L9,6.1L6,10.4L1.7,6C0.6,8.4 1,11.4 3,13.4C4.9,15.3 7.6,15.8 9.9,14.9L19,24L22.7,19Z" /></svg>`;
            header.appendChild(adminIcon);
        }

        contentDiv.appendChild(header);

        // Bubble
        const bubble = document.createElement('div');
        let bubbleClass = 'variant-white';
        if (msg.guard === 3) bubbleClass = 'variant-blue';
        if (msg.guard === 2) bubbleClass = 'variant-purple';
        if (msg.guard === 1) bubbleClass = 'variant-orange';

        bubble.className = `bubble ${bubbleClass}`;
        bubble.innerHTML = msg.content;
        
        contentDiv.appendChild(bubble);
        item.appendChild(contentDiv);

        chatBox.appendChild(item);
        cleanUpMessages();
    }

    function cleanUpMessages() {
        const children = Array.from(chatBox.children);
        children.forEach(child => {
             const rect = child.getBoundingClientRect();
             if (rect.bottom < 0) {
                 child.remove();
             }
        });
        if (children.length > 100) {
            children[0].remove();
        }
    }

</script>
</body>
</html>