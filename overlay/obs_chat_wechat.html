<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="referrer" content="no-referrer" />
    <title>OBS Chat - WeChat Style</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Jost:ital,wght@0,400;0,600;1,400;1,600&display=swap');

        :root {
            --font-stack: 'Jost', "MiSans Regular", "MiSans", sans-serif;
            --bg-color: transparent;
            --gap: 12px;
            --avatar-size: 44px;
            
            /* Bubble Colors */
            --bubble-purple: rgb(233, 204, 240); /* Level 2 - Admiral */
            --bubble-blue: rgb(200, 221, 252);   /* Level 3 - Captain */
            --bubble-orange: rgb(253, 213, 186); /* Level 1 - Governor */
            --bubble-white: #f1fbf5;             /* Normal - Mint White */
            --bubble-grey: #F5F5F5;
            
            /* Text Colors */
            --text-primary: #191919;
            --text-secondary: #888888;
            --name-color: #333333; /* Normal user - Black/Dark Grey */
            
            /* Guard Name Colors (Matching Console/User Description) */
            --name-guard-3: #5896DE; /* Captain - Blue */
            --name-guard-2: #9C27B0; /* Admiral - Deep Purple */
            --name-guard-1: #BB8613; /* Governor - Deep Gold */
            
            /* SC Colors (Console Match) */
            /* Level 0: < 50 */
            --sc-0-body: #2a60b2; --sc-0-header: #dcebff; --sc-0-text: #ffffff; --sc-0-header-text: #333333;
            /* Level 1: 50-99 */
            --sc-1-body: #427d9e; --sc-1-header: #e0eff5; --sc-1-text: #ffffff; --sc-1-header-text: #333333;
            /* Level 2: 100-499 */
            --sc-2-body: #f2c060; --sc-2-header: #fff8e6; --sc-2-text: #6d4c09; --sc-2-header-text: #6d4c09;
            /* Level 3: 500-999 */
            --sc-3-body: #f59654; --sc-3-header: #fff0e3; --sc-3-text: #ffffff; --sc-3-header-text: #333333;
            /* Level 4: 1000-1999 */
            --sc-4-body: #f76868; --sc-4-header: #ffebeb; --sc-4-text: #ffffff; --sc-4-header-text: #333333;
            /* Level 5: > 2000 */
            --sc-5-body: #c42742; --sc-5-header: #fcebeb; --sc-5-text: #ffffff; --sc-5-header-text: #333333;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            font-family: var(--font-stack);
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        .chat-container {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: calc(100% - 40px);
            max-width: 600px;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            gap: 16px;
            pointer-events: none; /* Let clicks pass through if needed */
        }

        /* Animations */
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeOut {
            from { opacity: 1; transform: scale(1); max-height: 500px; margin-bottom: var(--gap); }
            to { opacity: 0; transform: scale(0.9); max-height: 0; margin-bottom: 0; }
        }

        .chat-item {
            pointer-events: auto; /* Re-enable clicks on items */
            display: flex;
            flex-direction: row;
            align-items: flex-start;
            gap: var(--gap);
            animation: slideIn 0.4s cubic-bezier(0.25, 1, 0.5, 1) forwards;
            transform-origin: left bottom;
            width: 100%; /* Full width for SC cards */
        }

        .chat-item.removing {
            animation: fadeOut 0.4s cubic-bezier(0.25, 1, 0.5, 1) forwards;
            pointer-events: none;
        }

        /* Avatar */
        .avatar {
            width: var(--avatar-size);
            height: var(--avatar-size);
            flex-shrink: 0;
            border-radius: 6px; /* Rounded square like WeChat */
            overflow: hidden;
            background: #eee;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Content Column */
        .content {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            max-width: calc(100% - var(--avatar-size) - var(--gap));
            flex: 1; /* Allow growing */
        }

        /* Header: Name + Icon only */
        .header {
            display: flex;
            align-items: center;
            gap: 8px; /* Increased gap */
            margin-bottom: 4px;
            font-size: 13px;
            line-height: 1.2;
        }

        .name {
            color: var(--name-color);
            font-weight: bold; /* Ensure name is bold too */
            font-size: 16px; /* Slightly larger name */
        }
        
        .name.guard-3 { color: var(--name-guard-3); }
        .name.guard-2 { color: var(--name-guard-2); }
        .name.guard-1 { color: var(--name-guard-1); }

        /* Standalone Guard Icons (No Badge Box) */
        .icon-guard {
            display: inline-block;
            width: 24px; /* Slightly larger as requested */
            height: 24px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            vertical-align: middle;
        }
        
        /* Message Bubble */
        .bubble {
            position: relative;
            padding: 10px 14px;
            border-radius: 6px;
            font-size: 17px; /* Increased from 15px */
            line-height: 1.5;
            color: var(--text-primary);
            word-wrap: break-word;
            max-width: 100%;
            box-shadow: 0 1px 1px rgba(0,0,0,0.05);
            font-weight: bold; /* Bold text as requested */
        }
        
        /* Triangle Pointer */
        .bubble::before {
            content: "";
            position: absolute;
            left: -6px;
            top: 14px;
            width: 0;
            height: 0;
            border-top: 6px solid transparent;
            border-bottom: 6px solid transparent;
            border-right: 6px solid var(--bubble-bg, #fff);
        }

        /* Bubble Variants */
        .bubble.variant-purple { 
            background-color: var(--bubble-purple); 
            --bubble-bg: var(--bubble-purple);
        }
        .bubble.variant-blue { 
            background-color: var(--bubble-blue); 
            --bubble-bg: var(--bubble-blue);
        }
        .bubble.variant-orange { 
            background-color: var(--bubble-orange); 
            --bubble-bg: var(--bubble-orange);
        }
        .bubble.variant-white { 
            background-color: var(--bubble-white); 
            --bubble-bg: var(--bubble-white);
            border: 1px solid #ededed;
        }
        .bubble.variant-grey { 
            background-color: var(--bubble-grey); 
            --bubble-bg: var(--bubble-grey);
        }

        /* SC Card Styles */
        .sc-card {
            width: 100%;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            font-weight: bold;
            display: flex;
            flex-direction: column;
        }
        
        .sc-header {
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            background-color: var(--sc-header-bg);
            color: var(--sc-header-text);
        }
        
        .sc-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.5);
        }
        
        .sc-info {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .sc-name {
            font-size: 16px; /* Larger */
            font-weight: bold; /* Bold */
            opacity: 1;
        }
        
        .sc-price {
            font-size: 16px; /* Larger */
            font-weight: bold;
        }
        
        .sc-body {
            padding: 12px;
            font-size: 17px;
            line-height: 1.4;
            background-color: var(--sc-body-bg);
            color: var(--sc-body-text);
            word-wrap: break-word;
        }

        /* Gift Styles */
        /* Small Gift: Inline Bubble Style */
        .bubble.variant-gift-small {
            background-color: #fff0f6; /* Light Pink */
            border: 1px solid #ffadd2;
            color: #c41d7f;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .gift-icon-small {
            width: 24px;
            height: 24px;
            object-fit: contain;
        }

        /* Large Gift: Card Style (Similar to SC) */
        .gift-card {
            width: 100%;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            font-weight: bold;
            display: flex;
            flex-direction: row;
            align-items: center;
            padding: 10px;
            color: white;
            position: relative;
        }

        .gift-card.price-high {
            background: linear-gradient(135deg, #ffec3d 0%, #faad14 100%); /* Gold for > 99 */
            color: #613400;
        }

        .gift-card.price-mid {
            background: linear-gradient(135deg, #ffadd2 0%, #eb2f96 100%); /* Pink for 30-99 */
            color: white;
        }

        .gift-card-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.8);
            margin-right: 12px;
        }

        .gift-card-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .gift-card-name {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 2px;
        }

        .gift-card-action {
            font-size: 16px;
        }

        .gift-card-icon {
            width: 48px;
            height: 48px;
            object-fit: contain;
            margin-left: 12px;
        }
        
        /* Guard Card Styles */
        .guard-card {
            width: 100%;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            font-weight: bold;
            display: flex;
            flex-direction: row;
            align-items: center;
            padding: 12px;
            color: white;
            position: relative;
            animation: slideIn 0.4s cubic-bezier(0.25, 1, 0.5, 1) forwards;
        }

        .guard-card.level-3 { background-color: #6D92E3; } /* Captain Blue */
        .guard-card.level-2 { background-color: #E386B0; } /* Admiral Pink */
        .guard-card.level-1 { background-color: #E89F43; } /* Governor Orange */

        .guard-card-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.9);
            margin-right: 12px;
        }

        .guard-card-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .guard-card-title {
            font-size: 18px;
            line-height: 1.2;
            margin-bottom: 4px;
        }

        .guard-card-name {
            font-size: 14px;
            opacity: 0.9;
        }

        .guard-card-icon {
            width: 56px;
            height: 56px;
            object-fit: contain;
            margin-left: 8px;
            opacity: 0.9;
        }

        /* SC Level Variants */
        .sc-level-0 { --sc-header-bg: var(--sc-0-header); --sc-body-bg: var(--sc-0-body); --sc-body-text: var(--sc-0-text); --sc-header-text: var(--sc-0-header-text); }
        .sc-level-1 { --sc-header-bg: var(--sc-1-header); --sc-body-bg: var(--sc-1-body); --sc-body-text: var(--sc-1-text); --sc-header-text: var(--sc-1-header-text); }
        .sc-level-2 { --sc-header-bg: var(--sc-2-header); --sc-body-bg: var(--sc-2-body); --sc-body-text: var(--sc-2-text); --sc-header-text: var(--sc-2-header-text); }
        .sc-level-3 { --sc-header-bg: var(--sc-3-header); --sc-body-bg: var(--sc-3-body); --sc-body-text: var(--sc-3-text); --sc-header-text: var(--sc-3-header-text); }
        .sc-level-4 { --sc-header-bg: var(--sc-4-header); --sc-body-bg: var(--sc-4-body); --sc-body-text: var(--sc-4-text); --sc-header-text: var(--sc-4-header-text); }
        .sc-level-5 { --sc-header-bg: var(--sc-5-header); --sc-body-bg: var(--sc-5-body); --sc-body-text: var(--sc-5-text); --sc-header-text: var(--sc-5-header-text); }

        /* Emotes inside text */
        .emote {
            height: 24px;
            vertical-align: text-bottom;
            margin: 0 2px;
        }

        /* Large Sticker */
        .sticker {
            max-width: 60px; /* Reduced from 120px */
            border-radius: 4px;
            display: block;
        }
    </style>
</head>
<body>

<div class="chat-container" id="chat-box">
    <!-- Test Data will be injected here -->
</div>

<script src="mock_data.js"></script>
<script>
    const chatBox = document.getElementById('chat-box');
    
    // Check if mock data is loaded
    if (typeof MOCK_USERS === 'undefined') {
        console.error('Mock data not loaded! Please ensure mock_data.js exists.');
    }

    function getRandomItem(arr) {
        return arr[Math.floor(Math.random() * arr.length)];
    }

    function addMessage(msg) {
        const item = document.createElement('div');
        item.className = 'chat-item'; // Animation is applied via CSS class

        // Handle SuperChat Render Logic
        if (msg.type === 'super-chat') {
            // SC has a completely different structure (Card)
            const scCard = document.createElement('div');
            scCard.className = `sc-card sc-level-${msg.level}`;
            
            // Header
            const header = document.createElement('div');
            header.className = 'sc-header';
            
            const avatar = document.createElement('img');
            avatar.src = msg.avatar;
            avatar.className = 'sc-avatar';
            header.appendChild(avatar);
            
            const info = document.createElement('div');
            info.className = 'sc-info';
            
            const name = document.createElement('div');
            name.className = 'sc-name';
            name.innerText = msg.name;
            info.appendChild(name);
            
            const price = document.createElement('div');
            price.className = 'sc-price';
            price.innerText = `CN¥${msg.price}`;
            info.appendChild(price);
            
            header.appendChild(info);
            scCard.appendChild(header);
            
            // Body
            const body = document.createElement('div');
            body.className = 'sc-body';
            body.innerText = msg.content;
            scCard.appendChild(body);
            
            item.appendChild(scCard);
            chatBox.appendChild(item);
            cleanUpMessages();
            return;
        }

        // Handle Gift Render Logic
        if (msg.type === 'gift') {
            const isBig = msg.price * msg.num > 29;
            
            if (isBig) {
                // Large Gift Card
                const giftCard = document.createElement('div');
                giftCard.className = `gift-card ${msg.price * msg.num > 99 ? 'price-high' : 'price-mid'}`;
                
                const avatar = document.createElement('img');
                avatar.src = msg.avatar;
                avatar.className = 'gift-card-avatar';
                giftCard.appendChild(avatar);
                
                const content = document.createElement('div');
                content.className = 'gift-card-content';
                
                const name = document.createElement('div');
                name.className = 'gift-card-name';
                name.innerText = msg.name;
                content.appendChild(name);
                
                const action = document.createElement('div');
                action.className = 'gift-card-action';
                const totalPrice = parseFloat((msg.price * msg.num).toFixed(1));
                action.innerHTML = `投喂 <span>${msg.giftName}</span> x${msg.num} <span style="font-size:0.9em; opacity:0.8; margin-left:4px;">(CN¥${totalPrice})</span>`;
                content.appendChild(action);
                
                giftCard.appendChild(content);
                
                const icon = document.createElement('img');
                icon.src = msg.giftIcon;
                icon.className = 'gift-card-icon';
                giftCard.appendChild(icon);
                
                item.appendChild(giftCard);
            } else {
                // Small Gift (Inline Bubble)
                // Reuse Standard Avatar Layout
                const avatarDiv = document.createElement('div');
                avatarDiv.className = 'avatar';
                avatarDiv.innerHTML = `<img src="${msg.avatar}">`;
                item.appendChild(avatarDiv);
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'content';
                
                // Header
                const header = document.createElement('div');
                header.className = 'header';
                const nameSpan = document.createElement('span');
                nameSpan.className = 'name';
                nameSpan.innerText = msg.name;
                header.appendChild(nameSpan);
                contentDiv.appendChild(header);
                
                // Gift Bubble
                const bubble = document.createElement('div');
                bubble.className = 'bubble variant-gift-small';
                const totalPrice = parseFloat((msg.price * msg.num).toFixed(1));
                bubble.innerHTML = `
                    <span>投喂</span>
                    <img src="${msg.giftIcon}" class="gift-icon-small">
                    <span>${msg.giftName} x${msg.num}</span>
                    <span style="font-size:0.9em; opacity:0.6; margin-left:2px;">(CN¥${totalPrice})</span>
                `;
                contentDiv.appendChild(bubble);
                item.appendChild(contentDiv);
            }
            
            chatBox.appendChild(item);
            cleanUpMessages();
            return;
        }

        // Handle Guard Buy Logic
        if (msg.type === 'guard-buy') {
            const guardCard = document.createElement('div');
            guardCard.className = `guard-card level-${msg.guardLevel}`;
            
            const avatar = document.createElement('img');
            avatar.src = msg.avatar;
            avatar.className = 'guard-card-avatar';
            guardCard.appendChild(avatar);
            
            const content = document.createElement('div');
            content.className = 'guard-card-content';
            
            const title = document.createElement('div');
            title.className = 'guard-card-title';
            const guardName = msg.guardLevel === 1 ? '总督' : (msg.guardLevel === 2 ? '提督' : '舰长');
            title.innerHTML = `欢迎 <span>${msg.name}</span> 开通 ${guardName}`;
            content.appendChild(title);
            
            const sub = document.createElement('div');
            sub.className = 'guard-card-name';
            sub.innerText = `${msg.num} 个月`;
            content.appendChild(sub);
            
            guardCard.appendChild(content);
            
            const icon = document.createElement('img');
            // Use same CDN icons
            if (msg.guardLevel === 3) icon.src = 'https://i0.hdslb.com/bfs/activity-plat/static/20211222/627754775478985e330c25a90ec7baf0/icon-guard3.png@44w_44h.webp';
            else if (msg.guardLevel === 2) icon.src = 'https://i0.hdslb.com/bfs/activity-plat/static/20211222/627754775478985e330c25a90ec7baf0/icon-guard2.png@44w_44h.webp';
            else if (msg.guardLevel === 1) icon.src = 'https://i0.hdslb.com/bfs/activity-plat/static/20211222/627754775478985e330c25a90ec7baf0/icon-guard1.png@44w_44h.webp';
            
            icon.className = 'guard-card-icon';
            guardCard.appendChild(icon);
            
            item.appendChild(guardCard);
            chatBox.appendChild(item);
            cleanUpMessages();
            return;
        }

        // Standard Message Logic (WeChat Bubble)
        // Avatar
        const avatarDiv = document.createElement('div');
        avatarDiv.className = 'avatar';
        avatarDiv.innerHTML = `<img src="${msg.avatar}">`;
        item.appendChild(avatarDiv);

        // Content
        const contentDiv = document.createElement('div');
        contentDiv.className = 'content';

        // Header (Name + Guard Icon)
        const header = document.createElement('div');
        header.className = 'header';
        
        const nameSpan = document.createElement('span');
        nameSpan.className = 'name';
        if (msg.guard > 0) nameSpan.classList.add(`guard-${msg.guard}`);
        nameSpan.innerText = msg.name;
        header.appendChild(nameSpan);

        // Render Guard Icon if exists
        if (msg.guard > 0) {
            const iconImg = document.createElement('img');
            iconImg.className = 'icon-guard';
            
            // Map guard level to online Bilibili CDN images
            if (msg.guard === 3) iconImg.src = 'https://i0.hdslb.com/bfs/activity-plat/static/20211222/627754775478985e330c25a90ec7baf0/icon-guard3.png@44w_44h.webp';
            else if (msg.guard === 2) iconImg.src = 'https://i0.hdslb.com/bfs/activity-plat/static/20211222/627754775478985e330c25a90ec7baf0/icon-guard2.png@44w_44h.webp';
            else if (msg.guard === 1) iconImg.src = 'https://i0.hdslb.com/bfs/activity-plat/static/20211222/627754775478985e330c25a90ec7baf0/icon-guard1.png@44w_44h.webp';
            
            header.appendChild(iconImg);
        }

        contentDiv.appendChild(header);

        // Bubble
        const bubble = document.createElement('div');
        // Determine color based on guard level
        let bubbleClass = 'variant-white';
        if (msg.guard === 3) bubbleClass = 'variant-blue';
        if (msg.guard === 2) bubbleClass = 'variant-purple';
        if (msg.guard === 1) bubbleClass = 'variant-orange';

        bubble.className = `bubble ${bubbleClass}`;
        bubble.innerHTML = msg.content;
        
        contentDiv.appendChild(bubble);
        item.appendChild(contentDiv);

        // Append to DOM
        chatBox.appendChild(item);

        // Limit Messages
        cleanUpMessages();
    }

    function cleanUpMessages() {
        const children = Array.from(chatBox.children);
        
        // Remove items that are visibly off-screen (top)
        children.forEach(child => {
             const rect = child.getBoundingClientRect();
             // If bottom of element is above the top of viewport (scrolled out)
             if (rect.bottom < 0) {
                 child.remove();
             }
        });

        // Safety cap to prevent infinite growth if window is very tall
        if (children.length > 100) {
            children[0].remove();
        }
    }

    // Start Dynamic Simulation
    function startSimulation() {
        // Add random messages loop
        const loop = () => {
            // Speed up: 200ms - 800ms delay
            const delay = Math.random() * 600 + 200;
            setTimeout(() => {
                const rand = Math.random();
                // Clone user to avoid modifying the original mock data
                const user = { ...getRandomItem(MOCK_USERS) };
                
                // Apply random avatar from the large pool if available
                if (typeof MOCK_AVATARS !== 'undefined' && MOCK_AVATARS.length > 0) {
                    user.avatar = getRandomItem(MOCK_AVATARS);
                }
                
                let msg;
                if (rand > 0.9) { // 10% SC
                    const scData = getRandomItem(MOCK_SC);
                    msg = {
                        type: 'super-chat',
                        name: user.name,
                        avatar: user.avatar,
                        price: scData.price,
                        content: scData.content,
                        level: scData.level
                    };
                } else if (rand > 0.8) { // 10% Guard Buy
                    const level = Math.floor(Math.random() * 3) + 1; // 1-3
                    const num = Math.floor(Math.random() * 12) + 1;
                    msg = {
                        type: 'guard-buy',
                        name: user.name,
                        avatar: user.avatar,
                        guardLevel: level,
                        num: num
                    };
                } else if (rand > 0.65) { // 15% Gift
                    const giftData = getRandomItem(MOCK_GIFTS);
                    const num = Math.floor(Math.random() * 10) + 1; // 1-10
                    msg = {
                        type: 'gift',
                        name: user.name,
                        avatar: user.avatar,
                        giftName: giftData.name,
                        giftIcon: giftData.icon,
                        price: giftData.price,
                        num: num
                    };
                } else { // 65% Normal Chat
                    const text = getRandomItem(MOCK_CONTENT);
                    msg = {
                        type: 'chat',
                        name: user.name,
                        guard: user.guard,
                        avatar: user.avatar,
                        content: text
                    };
                }
                
                addMessage(msg);
                loop();
            }, delay);
        };
        loop();
    }
    
    startSimulation();
</script>
</body>
</html>